package main

import (
	"embed"
	"fmt"
	"io"
	"io/fs"
	"log"
	"math/rand"
	"net/http"
	"os"
	"path/filepath"
	"time"
)


//go:embed public/*
var webFS embed.FS

func apiClock(w http.ResponseWriter, r *http.Request) {
	io.WriteString(w, fmt.Sprintf(`{"ts":%d}`, time.Now().Unix()))
}

func staticHandler(w http.ResponseWriter, r *http.Request) {
	rawPath := r.URL.EscapedPath()


	if rawPath == "/" {
		data, _ := webFS.ReadFile("public/index.html")
		w.Header().Set("Content-Type", "text/html; charset=utf-8")
		w.Write(data)
		return
	}


	p := "." + rawPath
	if _, err := os.Stat(p); err != nil {
		http.NotFound(w, r)
		return
	}

	f, err := os.Open(p)
	if err != nil {
		http.NotFound(w, r)
		return
	}
	defer f.Close()

	fi, err := f.Stat()
	if err != nil {
		http.NotFound(w, r)
		return
	}

	http.ServeContent(w, r, filepath.Base(p), fi.ModTime(), f)
}

func main() {
	rand.Seed(time.Now().UnixNano())

	mux := http.NewServeMux()
	mux.HandleFunc("/api/clock", apiClock)


	publicFS, err := fs.Sub(webFS, "public")
	if err != nil {
		log.Fatalf("Failed to create sub filesystem: %v", err)
	}


	fileServer := http.FileServer(http.FS(publicFS))
	mux.Handle("/static/", http.StripPrefix("/static/", fileServer))


	mux.HandleFunc("/", staticHandler)

	addr := ":80"
	log.Printf("Guidance server starting on %s", addr)
	if err := http.ListenAndServe(addr, mux); err != nil {
		log.Fatalf("listen: %v", err)
	}
}
